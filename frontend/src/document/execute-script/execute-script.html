<transition name="execute-script-drawer">
<div class="fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/40" @click="close"></div>
  <div class="absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-xl flex flex-col">
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Run Script</h2>
        <p class="text-xs text-gray-500">Use <code class="bg-gray-100 px-1 rounded">doc</code> for this document.</p>
      </div>
      <button
        type="button"
        @click="close"
        class="text-gray-400 hover:text-gray-600 text-2xl leading-none"
        aria-label="Close drawer"
      >
        &times;
      </button>
    </div>
    <div class="flex-1 overflow-auto p-5 space-y-4">
      <div class="space-y-2">
        <label class="text-sm font-medium text-gray-700">Script</label>
        <textarea
          ref="scriptEditor"
          :value="scriptText"
          @input="updateScriptText"
          rows="8"
          placeholder="await doc.updateName('new name')&#10;return doc"
          class="w-full rounded-md border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 font-mono text-sm"
        ></textarea>
        <p class="text-xs text-gray-500">Return a value to see it in the output panel.</p>
      </div>
      <div class="flex items-center gap-3">
        <button
          type="button"
          @click="runDocumentScript"
          :disabled="scriptRunning"
          class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span v-if="scriptRunning">Running...</span>
          <span v-else>Run script</span>
        </button>
        <button
          type="button"
          @click="clearScript"
          class="text-sm text-gray-500 hover:text-gray-700"
        >
          Clear
        </button>
      </div>
      <div class="space-y-3">
        <div v-if="scriptError" class="rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">
          {{scriptError}}
        </div>
        <div v-if="scriptHasRun" class="rounded-md border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs uppercase tracking-wide text-gray-500 mb-2">Output</div>
          <pre class="whitespace-pre-wrap text-sm text-gray-800">{{formatScriptOutput(scriptResult)}}</pre>
        </div>
        <div v-if="scriptLogs" class="rounded-md border border-gray-200 bg-white p-3">
          <div class="text-xs uppercase tracking-wide text-gray-500 mb-2">Logs</div>
          <pre class="whitespace-pre-wrap text-xs text-gray-700">{{scriptLogs}}</pre>
        </div>
      </div>
    </div>
    <div class="border-t border-gray-200 px-5 py-3 text-xs text-gray-500">
      Scripts run on the server with access to the Mongoose document instance.
    </div>
  </div>
</div>
</transition>
