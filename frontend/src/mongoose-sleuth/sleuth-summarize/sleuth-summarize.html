<div class="flex flex-col w-full h-full">
  <!-- Header with step navigation -->
  <div class="bg-white border-b p-4">
    <div class="mb-2 flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold text-gray-900">Mongoose Sleuth</h1>
        <div class="flex items-center gap-2 mt-1 text-sm">
          <button
            type="button"
            class="font-semibold focus:outline-none"
            :class="sleuthContext.activeStep === 'aggregating'
              ? 'text-ultramarine-600'
              : 'text-gray-500 hover:text-ultramarine-600'"
            @click="sleuthContext.goToAggregating()"
          >
            Step 1: Aggregating
          </button>
          <span class="text-gray-400">•</span>
          <button
            type="button"
            class="font-semibold focus:outline-none"
            :class="sleuthContext.activeStep === 'investigating'
              ? 'text-ultramarine-600'
              : 'text-gray-500 hover:text-ultramarine-600'"
            @click="sleuthContext.goToInvestigating()"
          >
            Step 2: Investigating
          </button>
          <span class="text-gray-400">•</span>
          <button
            type="button"
            class="font-semibold focus:outline-none"
            :class="sleuthContext.activeStep === 'summarize'
              ? 'text-ultramarine-600'
              : 'text-gray-500 hover:text-ultramarine-600'"
            @click="sleuthContext.goToSummarize()"
          >
            Step 3: Summarize
          </button>
        </div>
      </div>
      <async-button
        v-if="!sleuthContext.aiSummary"
        type="button"
        class="inline-flex items-center rounded bg-ultramarine-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-ultramarine-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ultramarine-600"
        @click="sleuthContext.saveSummary()"
      >
        Save Summary
      </async-button>
      <div v-else class="text-xs text-gray-600">
        Case report resolved
      </div>
    </div>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <!-- Left: Summary textarea and AI summary -->
    <div class="flex-1 flex flex-col border-r border-gray-200">
      <div class="px-4 py-3 border-b border-gray-200">
        <h2 class="text-sm font-semibold text-gray-900">Case Summary</h2>
        <p class="text-xs text-gray-500 mt-1">Write a comprehensive summary of your findings and conclusions.</p>
      </div>
      <div class="flex-1 flex flex-col">
        <div v-if="sleuthContext.savingSummary" class="flex-1 flex items-center justify-center">
          <mongoose-loading></mongoose-loading>
        </div>
        <div v-else-if="!sleuthContext.aiSummary" class="flex-1 p-4">
          <label class="block text-xs font-medium text-gray-700 mb-2">Your Summary</label>
          <textarea
            v-model="sleuthContext.summary"
            class="w-full h-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-ultramarine-500 focus:outline-none focus:ring-1 focus:ring-ultramarine-500 resize-none"
            placeholder="Enter your case summary here..."
          ></textarea>
        </div>
        <div v-else class="flex-1 p-4 overflow-y-auto">
          <div class="mb-3">
            <label class="block text-xs font-medium text-gray-700 mb-2">AI-Enhanced Summary</label>
            <p class="text-xs text-gray-500 mb-2">This summary has been enhanced using AI and the case report is now resolved.</p>
          </div>
          <div class="w-full h-full rounded-md border border-gray-300 px-3 py-2 text-sm bg-gray-50 overflow-y-auto prose prose-sm max-w-none">
            <div v-html="renderMarkdown(sleuthContext.aiSummary)"></div>
          </div>
          <div v-if="sleuthContext.summary" class="mt-4 pt-4 border-t border-gray-200">
            <label class="block text-xs font-medium text-gray-700 mb-2">Original Summary (Read-only)</label>
            <div class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm bg-gray-50 text-gray-600 whitespace-pre-wrap">
              {{ sleuthContext.summary }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Document notes reference -->
    <div class="w-full md:w-1/2 flex flex-col">
      <div class="px-4 py-3 border-b border-gray-200">
        <h2 class="text-sm font-semibold text-gray-900">Investigation Notes</h2>
        <p class="text-xs text-gray-500 mt-1">Reference your notes while writing the summary.</p>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-3">
        <div
          v-for="doc in sleuthContext.investigationSelections"
          :key="sleuthContext.getDocumentKey(doc)"
          class="border border-gray-200 rounded-md p-3 bg-white shadow-sm"
        >
          <div class="mb-2">
            <div class="text-sm font-semibold text-gray-900">
              {{ doc.model }} – {{ doc._id }}
            </div>
          </div>
          <div v-if="sleuthContext.getDocumentNote(doc)" class="mt-2">
            <div class="text-xs font-medium text-gray-600 mb-1">Notes:</div>
            <div class="text-sm text-gray-700 bg-gray-50 rounded px-2 py-1 whitespace-pre-wrap">
              {{ sleuthContext.getDocumentNote(doc) }}
            </div>
          </div>
          <div v-else class="text-xs text-gray-400 italic mt-2">
            No notes for this document
          </div>
        </div>
        <div
          v-if="sleuthContext.investigationSelections.length === 0"
          class="text-sm text-gray-500 text-center py-8"
        >
          No documents selected for investigation. Go back to Step 2 to add notes.
        </div>
      </div>
    </div>
  </div>
</div>
