<div class="models flex" style="height: calc(100vh - 55px); height: calc(100dvh - 55px)">
  <div class="fixed top-[65px] cursor-pointer bg-gray-100 rounded-r-md z-10" @click="hideSidebar = false">
    <svg xmlns="http://www.w3.org/2000/svg" style="h-5 w-5" viewBox="0 -960 960 960" class="w-5" fill="#5f6368"><path d="M360-120v-720h80v720h-80Zm160-160v-400l200 200-200 200Z"/></svg>
  </div>
  <aside class="bg-white border-r overflow-y-auto overflow-x-hidden h-full transition-all duration-300 ease-in-out z-20 w-0 lg:w-48 fixed lg:relative shrink-0" :class="hideSidebar === true ? '!w-0' : hideSidebar === false ? '!w-48' : ''">
    <div class="flex items-center border-b border-gray-100 w-48 overflow-x-hidden">
      <div class="p-1 ml-2 font-bold">Models</div>
      <button
        @click="hideSidebar = true"
        class="ml-auto mr-2 p-2 rounded hover:bg-gray-200 focus:outline-none"
        aria-label="Close sidebar"
      >
        <svg xmlns="http://www.w3.org/2000/svg" style="h-5 w-5" viewBox="0 -960 960 960" class="w-5" fill="currentColor"><path d="M660-320v-320L500-480l160 160ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm120-80v-560H200v560h120Zm80 0h360v-560H400v560Zm-80 0H200h120Z"/></svg>
      </button>
    </div>
    <nav class="flex flex-1 flex-col">
      <ul role="list" class="flex flex-1 flex-col gap-y-7 p-1">
        <li>
          <ul role="list">
            <li v-for="model in models">
              <router-link
                :to="'/model/' + model"
                class="block truncate rounded-md py-2 pr-2 pl-2 text-sm text-gray-700"
                :class="model === currentModel ? 'bg-ultramarine-100 font-bold text-gray-900' : 'hover:bg-ultramarine-50'">
                {{model}}
              </router-link>
            </li>
          </ul>
        </li>
      </ul>
      <div v-if="models.length === 0 && status === 'loaded'" class="p-2 bg-red-100">
        No models found
      </div>
    </nav>
  </aside>
  <div class="documents bg-slate-50" ref="documentsList">
    <div class="relative min-h-[50px]" style="z-index: 1000">
      <div class="documents-menu bg-slate-50">
        <div class="flex flex-row items-center w-full gap-2 flex-wrap">
          <document-search
            ref="documentSearch"
            :value="searchText"
            :schema-paths="schemaPaths"
            @search="search"
          >
          </document-search>
          <div>
            <span v-if="numDocuments == null">Loading ...</span>
            <span v-else-if="typeof numDocuments === 'number'">{{documents.length}}/{{numDocuments === 1 ? numDocuments + ' document' : numDocuments + ' documents'}}</span>
          </div>
          <button
            @click="stagingSelect"
            type="button"
            :class="{ 'bg-gray-500 ring-inset ring-2 ring-gray-300 hover:bg-gray-600': selectMultiple, 'bg-ultramarine-600 hover:bg-ultramarine-500' : !selectMultiple }"
            class="rounded px-2 py-2 text-sm font-semibold text-white shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ultramarine-600"
          >
            {{ selectMultiple ? 'Cancel' : 'Select' }}
          </button>
          <button
            v-show="selectMultiple"
            @click="shouldShowUpdateMultipleModal=true;"
            type="button"
            class="rounded bg-green-600 px-2 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600"
            >
            Update
          </button>
          <button
            @click="shouldShowDeleteMultipleModal=true;"
            type="button"
            v-show="selectMultiple"
            class="rounded bg-red-600 px-2 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"
            >
            Delete
          </button>
          <div class="relative" v-show="!selectMultiple" ref="actionsMenuContainer" @keyup.esc.prevent="closeActionsMenu">
            <button
              @click="toggleActionsMenu"
              type="button"
              aria-label="More actions"
              class="rounded bg-white px-2 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ultramarine-600">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 6a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Zm0 6a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
              </svg>
            </button>
            <div
              v-if="showActionsMenu"
              class="absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-20"
            >
              <div class="py-1">
                <button
                  @click="shouldShowExportModal = true; showActionsMenu = false"
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                >
                  Export
                </button>
                <button
                  @click="shouldShowCreateModal = true; showActionsMenu = false"
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                >
                  Create
                </button>
                <button
                  @click="openIndexModal"
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                >
                  Indexes
                </button>
                <button
                  @click="openCollectionInfo"
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                >
                  Collection Info
                </button>
                <button
                  @click="findOldestDocument"
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                >
                  Find oldest document
                </button>
              </div>
            </div>
          </div>
          <span class="isolate inline-flex rounded-md shadow-sm">
            <button
              @click="setOutputType('table')"
              type="button"
              class="relative inline-flex items-center rounded-none rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10"
              :class="outputType === 'table' ? 'bg-gray-200' : 'bg-white'">
              <img class="h-5 w-5" src="images/table.svg">
            </button>
            <button
              @click="setOutputType('json')"
              type="button"
              class="relative -ml-px inline-flex items-center px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10"
              :class="outputType === 'json' ? 'bg-gray-200' : 'bg-white'">
              <img class="h-5 w-5" src="images/json.svg">
            </button>
            <button
              @click="setOutputType('map')"
              :disabled="geoJsonFields.length === 0"
              type="button"
              :title="geoJsonFields.length > 0 ? 'Map view' : 'No GeoJSON fields detected'"
              class="relative -ml-px inline-flex items-center rounded-none rounded-r-md px-2 py-2 ring-1 ring-inset ring-gray-300 focus:z-10"
              :class="[
                geoJsonFields.length === 0 ? 'text-gray-300 cursor-not-allowed bg-gray-100' : 'text-gray-400 hover:bg-gray-50',
                outputType === 'map' ? 'bg-gray-200' : (geoJsonFields.length > 0 ? 'bg-white' : '')
              ]">
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z" />
              </svg>
            </button>
          </span>
        </div>
      </div>
    </div>
    <div class="documents-container relative">
      <div v-if="error">
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 relative m-4 rounded-md" role="alert">
          <span class="block font-bold">Error</span>
          <span class="block">{{ error }}</span>
        </div>
      </div>
      <div v-else-if="outputType === 'table'" class="projection-view">
        <form class="projection-input-row" @submit.prevent="applyProjectionFromInput">
          <input
            ref="projectionInput"
            v-model="projectionText"
            type="text"
            placeholder="Projection (e.g. { _id: 1, name: 1 } or name age)"
            class="projection-input"
            @click="initProjection"
            @blur="applyProjectionFromInput"
          />
          <button
            type="button"
            class="projection-action-btn"
            title="Add all fields to projection"
            @click="addAllFields"
          >
            Add all
          </button>
          <button
            type="button"
            class="projection-action-btn"
            title="Reset to default (_id only)"
            @click="resetProjection"
          >
            Reset
          </button>
        </form>
        <div class="table-wrapper">
          <table class="projection-table">
            <thead>
              <tr>
                <th
                  v-for="schemaPath in filteredPaths"
                  :key="schemaPath.path"
                  class="table-header-cell"
                >
                  <div class="projection-column-def">
                    <span v-if="schemaPath.ref" class="column-ref-icon" title="Reference" aria-hidden="true">↗</span>
                    <span
                      class="column-name cursor-pointer truncate"
                      @click="addPathFilter(schemaPath.path)"
                      :title="schemaPath.path"
                    >
                      {{ schemaPath.path }}
                    </span>
                    <span class="column-type">{{ schemaPath.instance || 'unknown' }}</span>
                    <span class="column-sort cursor-pointer" @click.stop="sortDocs(1, schemaPath.path)" title="Sort ascending">↑</span>
                    <span class="column-sort cursor-pointer" @click.stop="sortDocs(-1, schemaPath.path)" title="Sort descending">↓</span>
                    <button
                      type="button"
                      class="column-remove"
                      :title="'Remove ' + schemaPath.path"
                      @click.stop="removeField(schemaPath)"
                      aria-label="Remove field"
                    >
                      ×
                    </button>
                  </div>
                </th>
                <th class="table-header-add">
                  <div class="projection-add-column" ref="addFieldContainer">
                    <button
                      type="button"
                      class="add-column-btn"
                      @click="toggleAddFieldDropdown"
                      aria-label="Add field"
                    >
                      +
                    </button>
                    <ul
                      v-if="showAddFieldDropdown"
                      class="add-field-dropdown"
                    >
                      <li
                        v-for="path in availablePathsToAdd"
                        :key="path.path"
                        class="add-field-option"
                        @click="addField(path)"
                      >
                        {{ path.path }}
                      </li>
                      <li v-if="availablePathsToAdd.length === 0" class="add-field-option add-field-empty">
                        No more fields to add
                      </li>
                    </ul>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="document in documents"
                :key="document._id"
                :class="{ 'table-row-selected': selectedDocuments.some(x => x._id.toString() === document._id.toString()) }"
                @click="handleDocumentClick(document, $event)"
              >
                <td
                  v-for="schemaPath in filteredPaths"
                  :key="schemaPath.path"
                  class="table-cell"
                >
                  <component
                    :is="getComponentForPath(schemaPath)"
                    :value="getValueForPath(document, schemaPath.path)"
                    :allude="getReferenceModel(schemaPath)">
                  </component>
                </td>
                <td class="table-cell-add"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div v-else-if="outputType === 'json'" class="json-view flex flex-col space-y-2">
        <div
          v-for="document in documents"
          :key="document._id"
          @click="handleDocumentContainerClick(document, $event)"
          :class="[
            'group relative transition-colors rounded-md border border-slate-100',
            selectedDocuments.some(x => x._id.toString() === document._id.toString()) ? 'bg-blue-200' : 'hover:shadow-sm hover:border-slate-300 bg-white'
          ]"
        >
          <button
            type="button"
            class="absolute top-2 right-2 z-10 inline-flex items-center rounded bg-ultramarine-600 px-2 py-1 text-xs font-semibold text-white shadow-sm transition-opacity duration-150 opacity-0 group-hover:opacity-100 focus-visible:opacity-100 hover:bg-ultramarine-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ultramarine-600"
            @click.stop="openDocument(document)"
          >
            Open this Document
          </button>
          <list-json :value="document" :references="referenceMap">
          </list-json>
        </div>
      </div>
      <div v-else-if="outputType === 'map'" class="flex flex-col h-full">
        <div class="p-2 bg-white border-b flex items-center gap-2">
          <label class="text-sm font-medium text-gray-700">GeoJSON Field:</label>
          <select
            :value="selectedGeoField"
            @change="setSelectedGeoField($event.target.value)"
            class="rounded-md border border-gray-300 py-1 px-2 text-sm focus:border-ultramarine-500 focus:ring-ultramarine-500"
          >
            <option v-for="field in geoJsonFields" :key="field.path" :value="field.path">
              {{ field.label }}
            </option>
          </select>
          <async-button
            @click="loadMoreDocuments"
            :disabled="loadedAllDocs"
            type="button"
            class="rounded px-2 py-1 text-xs font-semibold text-white shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ultramarine-600"
            :class="loadedAllDocs ? 'bg-gray-400 cursor-not-allowed' : 'bg-ultramarine-600 hover:bg-ultramarine-500'"
          >
            Load more
          </async-button>
        </div>
        <div class="flex-1 min-h-[400px]" ref="modelsMap"></div>
      </div>
      <div v-if="status === 'loading'" class="loader">
        <img src="images/loader.gif">
      </div>
    </div>
  </div>
  <modal v-if="shouldShowExportModal">
    <template v-slot:body>
      <div class="modal-exit" @click="shouldShowExportModal = false">&times;</div>
      <export-query-results
        :schemaPaths="schemaPaths"
        :search-text="searchText"
        :currentModel="currentModel"
        @done="shouldShowExportModal = false">
      </export-query-results>
    </template>
  </modal>
  <modal v-if="shouldShowIndexModal">
    <template v-slot:body>
      <div class="modal-exit" @click="shouldShowIndexModal = false">&times;</div>
      <div class="text-xl font-bold mb-2">Indexes</div>
      <div v-for="index in mongoDBIndexes" class="w-full flex items-center">
        <div class="grow shrink text-left flex justify-between items-center" v-if="index.name != '_id_'">
          <div>
            <div class="font-bold flex items-center gap-2">
              <div>{{ index.name }}</div>
              <div v-if="isTTLIndex(index)" class="rounded-full bg-ultramarine-100 px-2 py-0.5 text-xs font-semibold text-ultramarine-700">
                TTL: {{ formatTTL(index.expireAfterSeconds) }}
              </div>
            </div>
            <div class="text-sm font-mono">{{ JSON.stringify(index.key) }}</div>
          </div>
          <div>
            <async-button
              type="button"
              @click="dropIndex(index.name)"
              class="rounded-md bg-valencia-600 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-valencia-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
              Drop
            </async-button>
          </div>
        </div>
      </div>
    </template>
  </modal>
  <modal v-if="shouldShowCollectionInfoModal">
    <template v-slot:body>
      <div class="modal-exit" @click="shouldShowCollectionInfoModal = false">&times;</div>
      <div class="text-xl font-bold mb-2">Collection Info</div>
      <div v-if="!collectionInfo" class="text-gray-600">Loading collection details...</div>
      <div v-else class="space-y-3">
        <div class="flex justify-between gap-4">
          <div class="font-semibold text-gray-700">Documents</div>
          <div class="text-gray-900">{{ formatNumber(collectionInfo.documentCount) }}</div>
        </div>
        <div class="flex justify-between gap-4">
          <div class="font-semibold text-gray-700">Indexes</div>
          <div class="text-gray-900">{{ formatNumber(collectionInfo.indexCount) }}</div>
        </div>
        <div class="flex justify-between gap-4">
          <div class="font-semibold text-gray-700">Total Index Size</div>
          <div class="text-gray-900">{{ formatCollectionSize(collectionInfo.totalIndexSize) }}</div>
        </div>
        <div class="flex justify-between gap-4">
          <div class="font-semibold text-gray-700">Total Storage Size</div>
          <div class="text-gray-900">{{ formatCollectionSize(collectionInfo.size) }}</div>
        </div>
        <div class="flex flex-col gap-1">
          <div class="flex justify-between gap-4">
            <div class="font-semibold text-gray-700">Collation</div>
            <div class="text-gray-900">{{ collectionInfo.hasCollation ? 'Yes' : 'No' }}</div>
          </div>
          <div v-if="collectionInfo.hasCollation" class="rounded bg-gray-100 p-3 text-sm text-gray-800 overflow-x-auto">
            <pre class="whitespace-pre-wrap">{{ JSON.stringify(collectionInfo.collation, null, 2) }}</pre>
          </div>
        </div>
        <div class="flex justify-between gap-4">
          <div class="font-semibold text-gray-700">Capped</div>
          <div class="text-gray-900">{{ collectionInfo.capped ? 'Yes' : 'No' }}</div>
        </div>
      </div>
    </template>
  </modal>
  <modal v-if="shouldShowCreateModal">
    <template v-slot:body>
      <div class="modal-exit" @click="shouldShowCreateModal = false;">&times;</div>
      <create-document :currentModel="currentModel" :paths="schemaPaths" @close="closeCreationModal"></create-document>
    </template>
  </modal>
  <modal v-if="shouldShowUpdateMultipleModal">
    <template v-slot:body>
      <div class="modal-exit" @click="shouldShowUpdateMultipleModal = false;">&times;</div>
      <update-document :currentModel="currentModel" :document="selectedDocuments" :multiple="true" @update="updateDocuments" @close="shouldShowUpdateMultipleModal=false;"></update-document>
    </template>
  </modal>
  <modal v-if="shouldShowDeleteMultipleModal">
    <template v-slot:body>
      <div class="modal-exit" @click="shouldShowDeleteMultipleModal = false;">&times;</div>
      <h2>Are you sure you want to delete {{selectedDocuments.length}} documents?</h2>
      <div>
        <list-json :value="selectedDocuments"></list-json>
      </div>
      <div class="flex gap-4">
        <async-button @click="deleteDocuments" class="rounded bg-red-500 px-2 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
          Confirm
        </async-button>
        <button @click="shouldShowDeleteMultipleModal = false;" class="rounded bg-gray-400 px-2 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500">
          Cancel
        </button>
      </div>
    </template>
  </modal>
</div>
